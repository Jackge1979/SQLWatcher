[{"type":"Oracle","data":[
{"title":"查询RMAN的所有备份信息",
"sql":"SELECT A.RECID BS_KEY,
       C.RECID BP_KEY,
       CASE
         WHEN A.BACKUP_TYPE = 'L' THEN
          'Archived Redo Logs'
         WHEN A.BACKUP_TYPE = 'D' AND A.INCREMENTAL_LEVEL IS NULL THEN
          'Datafile Full Backup'
         WHEN A.BACKUP_TYPE = 'I' OR A.INCREMENTAL_LEVEL IS NOT NULL THEN
          'Incremental Backup'
       END BACKUP_TYPE,
       A.INCREMENTAL_LEVEL,
       AA.BS_BYTES,
       TO_CHAR(A.START_TIME, 'YYYY-MM-DD HH24:MI:SS') START_TIME,
       TO_CHAR(A.COMPLETION_TIME, 'YYYY-MM-DD HH24:MI:SS') END_TIME,
       A.ELAPSED_SECONDS,
       C.HANDLE PIECE_NAME,
       C.DEVICE_TYPE,
       C.TAG,
       AA.BS_STATUS,
       AA.BS_COMPRESSED,
       A.CONTROLFILE_INCLUDED,
       A.KEEP,
       A.KEEP_UNTIL,
       A.KEEP_OPTIONS,
       ------ data file -------- 
       B.FILE#,
       B.INCREMENTAL_LEVEL DF_INCREMENTAL_LEVEL,
       (SELECT NB.NAME FROM V$DATAFILE NB WHERE NB.FILE# = B.FILE#) DATAFILENAME,
       B.USED_CHANGE_TRACKING,
       B.CHECKPOINT_CHANGE# || '' DF_CHECKPOINT_CHANGE#,
       B.CHECKPOINT_TIME DF_CHECKPOINT_TIME,
       ------ archive log file --------
       D.THREAD#,
       D.SEQUENCE#,
       D.RESETLOGS_CHANGE#,
       D.FIRST_CHANGE#,
       D.FIRST_TIME,
       D.NEXT_CHANGE#,
       D.NEXT_TIME,
       ------ spfile --------
       E.MODIFICATION_TIME,
       E.DB_UNIQUE_NAME,
       ------ control file --------
       F.CREATION_TIME,
       F.CHECKPOINT_CHANGE# || '' CF_CHECKPOINT_CHANGE#,
       F.CHECKPOINT_TIME CF_CHECKPOINT_TIME,
       F.FILESIZE_DISPLAY
  FROM V$BACKUP_SET A
  LEFT OUTER JOIN V$BACKUP_FILES AA
    ON (AA.BS_KEY = A.RECID AND AA.FILE_TYPE = 'PIECE')
  LEFT OUTER JOIN V$BACKUP_DATAFILE B
    ON (A.SET_STAMP = B.SET_STAMP AND A.SET_COUNT = B.SET_COUNT)
  LEFT OUTER JOIN V$BACKUP_PIECE C
    ON (A.SET_STAMP = C.SET_STAMP AND A.SET_COUNT = C.SET_COUNT)
  LEFT OUTER JOIN V$BACKUP_ARCHIVELOG_DETAILS D
    ON (D.BTYPE_KEY = A.RECID)
  LEFT OUTER JOIN V$BACKUP_SPFILE E
    ON (A.SET_STAMP = E.SET_STAMP AND A.SET_COUNT = E.SET_COUNT)
  LEFT OUTER JOIN V$BACKUP_CONTROLFILE_DETAILS F
    ON (F.BTYPE_KEY = A.RECID)
 ORDER BY A.RECID, A.RECID, B.FILE#, D.THREAD#, D.SEQUENCE#;
"},
{"title":"查询归档日志的生成情况",
"sql":"通过视图GV$ARCHIVED_LOG可以查询到日志的生成情况，如下所示：
SELECT A.THREAD# THREAD#,
       A.F_TIME F_TIME,
       ROUND(SUM(A.BLOCKS * A.BLOCK_SIZE) / 1024 / 1024) 每天归档日志量_M,
       ROUND(SUM(A.BLOCKS * A.BLOCK_SIZE) / 1024 / 1024 / 24, 2) 每小时平均归档日志量_M,
       COUNT(1)  归档文件数
  FROM (SELECT DISTINCT SEQUENCE#,
                        THREAD#,
                        BLOCKS,
                        BLOCK_SIZE,
                        TO_CHAR(FIRST_TIME, 'yyyy-mm-dd') F_TIME
          FROM GV$ARCHIVED_LOG T
         WHERE T.FIRST_TIME <= SYSDATE) A
 GROUP BY A.F_TIME, A.THREAD#
 ORDER BY 1, 2 DESC;
"},
{
"title":"查询ASM磁盘的使用情况",
"sql":"SELECT A.GROUP_NUMBER,
       A.DISK_NUMBER,
       A.NAME,
       A.PATH,
       A.STATE,
       A.MOUNT_STATUS,
       A.TOTAL_MB,
       A.FREE_MB,
       A.CREATE_DATE,
       A.MOUNT_DATE,
       A.LIBRARY,
       A.OS_MB
  FROM V$ASM_DISK A
  ORDER BY  A.GROUP_NUMBER,
       A.DISK_NUMBER;
"
},
{
"title":"查询ASM磁盘组的使用情况",
"sql":"SELECT DI.GROUP_NUMBER,
       DI.NAME,
       DI.BLOCK_SIZE,
       DI.STATE,
       DI.TYPE,
       DI.TOTAL_MB,
       DI.FREE_MB,
       DI.COMPATIBILITY,
       DI.VOTING_FILES,
       DI.OFFLINE_DISKS
  FROM V$ASM_DISKGROUP DI
 ORDER BY DI.GROUP_NUMBER;"
},
{
"title":"查询数据库闪回空间的使用情况",
"sql":"通过视图V$RECOVERY_FILE_DEST可以查询闪回空间的使用情况，其SQL如下所示：
SELECT NAME,
       TRUNC(SPACE_LIMIT/1024/1024/1024, 3) LIMIT_GB,
       TRUNC(SPACE_USED/1024/1024/1024, 3) USED_GB,
       TRUNC(SPACE_USED / SPACE_LIMIT, 3) \"USED%\",
       TRUNC(SPACE_RECLAIMABLE, 3) RECLAIM,
       NUMBER_OF_FILES
  FROM V$RECOVERY_FILE_DEST V
 WHERE V.SPACE_LIMIT <> 0;

若想查询详细使用情况，可以执行如下的SQL语句：
SELECT NVL(FRAU.FILE_TYPE, 'Total:') FILE_TYPE,
       SUM(ROUND(FRAU.PERCENT_SPACE_USED / 100 * RFD.SPACE_LIMIT / 1024 / 1024 / 1024,3)) USED_GB,
       SUM(FRAU.PERCENT_SPACE_USED) PERCENT_SPACE_USED,
       SUM(FRAU.PERCENT_SPACE_RECLAIMABLE) PERCENT_SPACE_RECLAIMABLE,
       SUM(ROUND(FRAU.PERCENT_SPACE_RECLAIMABLE / 100 * RFD.SPACE_LIMIT / 1024 / 1024 / 1024,3)) RECLAIM_GB,
       SUM(FRAU.NUMBER_OF_FILES) NUMBER_OF_FILES
  FROM V$FLASH_RECOVERY_AREA_USAGE FRAU, V$RECOVERY_FILE_DEST RFD
 GROUP BY ROLLUP(FILE_TYPE);
"
},
{
"title":"查询到数据库的增长情况",
"sql":"可以通过视图DBA_HIST_TBSPC_SPACE_USAGE来获取数据库的增长情况，具体查询语句及结果如下所示：
SELECT TO_CHAR(DATETIME, 'YYYY-MM-DD') DATETIME,
       TRUNC(SUM(TS_USED_SIZE) / 1024 / 1024) TS_USED_SIZE_M,
       TRUNC(SUM(TS_SIZE) / 1024 / 1024) TS_SIZE_M,
       TRUNC(SUM(TS_MAXSIZE) / 1024 / 1024) TS_MAXSIZE_M
  FROM (SELECT A.NAME, B.*
          FROM V$TABLESPACE A,
               (SELECT TABLESPACE_ID TS#,
                       TRUNC(TO_DATE(RTIME, 'MM/DD/YYYY HH24:MI:SS')) DATETIME,
                       (MAX(TABLESPACE_USEDSIZE * 8 * 1024)) TS_USED_SIZE,
                       (MAX(V.TABLESPACE_SIZE * 8 * 1024)) TS_SIZE,
                       (MAX(TABLESPACE_MAXSIZE * 8 * 1024)) TS_MAXSIZE
                  FROM DBA_HIST_TBSPC_SPACE_USAGE V
                 WHERE TRUNC(TO_DATE(RTIME, 'MM/DD/YYYY HH24:MI:SS')) >=
                       TRUNC(SYSDATE - 15)
                 GROUP BY TABLESPACE_ID,
                          TRUNC(TO_DATE(RTIME, 'MM/DD/YYYY HH24:MI:SS'))
                 ORDER BY TABLESPACE_ID,
                          TRUNC(TO_DATE(RTIME, 'MM/DD/YYYY HH24:MI:SS'))) B
         WHERE A.TS# = B.TS#)
 GROUP BY TO_CHAR(DATETIME, 'YYYY-MM-DD')
 ORDER BY DATETIME;

 若是需要按照表空间来展示，则可以运行如下的代码：
SELECT A.NAME,
       B.TS#,
       TO_CHAR(DATETIME, 'YYYY-MM-DD') DATETIME,
       TS_USED_SIZE_M,
       TS_SIZE_M,
       TS_MAXSIZE_M
  FROM V$TABLESPACE A,
       (SELECT TABLESPACE_ID TS#,
               TRUNC(TO_DATE(RTIME, 'MM/DD/YYYY HH24:MI:SS')) DATETIME,
               TRUNC(MAX(TABLESPACE_USEDSIZE * 8 * 1024)/1024/1024) TS_USED_SIZE_M,
               TRUNC(MAX(V.TABLESPACE_SIZE * 8 * 1024)/1024/1024) TS_SIZE_M,
               TRUNC(MAX(TABLESPACE_MAXSIZE * 8 * 1024)/1024/1024) TS_MAXSIZE_M
          FROM DBA_HIST_TBSPC_SPACE_USAGE V
         WHERE TRUNC(TO_DATE(RTIME, 'MM/DD/YYYY HH24:MI:SS')) >=
               TRUNC(SYSDATE - 7)
         GROUP BY TABLESPACE_ID,
                  TRUNC(TO_DATE(RTIME, 'MM/DD/YYYY HH24:MI:SS'))
         ORDER BY TABLESPACE_ID,
                  TRUNC(TO_DATE(RTIME, 'MM/DD/YYYY HH24:MI:SS'))) B
 WHERE A.TS# = B.TS#
 ORDER BY B.TS#, B.DATETIME;
"
}]}]
